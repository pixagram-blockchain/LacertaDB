<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LacertaDB Management Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f1f5f9;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #334155;
        }

        .container {
            display: flex;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--dark);
            color: white;
            padding: 20px 0;
            overflow-y: auto;
        }

        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: var(--primary);
            position: relative;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: white;
        }

        .nav-icon {
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8fafc;
        }

        .panel {
            display: none;
            animation: fadeIn 0.3s;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .panel-subtitle {
            color: var(--secondary);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-label {
            font-size: 14px;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        tr:hover {
            background: var(--light);
        }

        td.actions {
            display: flex;
            gap: 5px;
        }

        td.document-id {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Console */
        .console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .console-line {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .console-prompt {
            color: #00ff00;
        }

        .console-error {
            color: #ff4444;
        }

        .console-success {
            color: #00ff00;
        }

        /* Query Builder */
        .query-builder {
            display: flex;
            gap: 20px;
        }

        .query-section {
            flex: 1;
        }

        .query-results {
            margin-top: 20px;
            max-height: 500px;
            overflow: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: fadeIn 0.3s;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            color: var(--secondary);
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s forwards;
            z-index: 2000;
        }

        @keyframes slideOut {
            to { transform: translateX(110%); opacity: 0; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--border);
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: var(--light);
        }

        .file-upload.dragover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        /* Code Editor / JSON Viewer */
        .code-editor, .json-viewer {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .json-viewer {
            background: #fdfdff;
            border: 1px solid var(--border);
            color: #333;
            padding: 15px;
            border-radius: 8px;
            overflow: auto;
            max-height: 400px;
            white-space: pre;
        }

        .json-key {
            color: #a31515;
        }

        .json-string {
            color: #0451a5;
        }

        .json-number {
            color: #098658;
        }

        .json-boolean {
            color: #0000ff;
        }
        .json-null {
            color: #ff5555;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1>ü¶é LacertaDB</h1>
        </div>
        <nav>
            <div class="nav-item active" data-panel="dashboard">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-panel="documents">
                <span class="nav-icon">üìÑ</span>
                <span>Documents</span>
            </div>
            <div class="nav-item" data-panel="query">
                <span class="nav-icon">üîç</span>
                <span>Query Builder</span>
            </div>
            <div class="nav-item" data-panel="collections">
                <span class="nav-icon">üìÅ</span>
                <span>Collections</span>
            </div>
            <div class="nav-item" data-panel="sync">
                <span class="nav-icon">‚òÅÔ∏è</span>
                <span>Sync & Backup</span>
            </div>
            <div class="nav-item" data-panel="performance">
                <span class="nav-icon">‚ö°</span>
                <span>Performance</span>
            </div>
            <div class="nav-item" data-panel="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </div>
            <div class="nav-item" data-panel="developer">
                <span class="nav-icon">üîß</span>
                <span>Developer</span>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Panel -->
        <div class="panel active" id="dashboard">
            <div class="panel-header">
                <h2 class="panel-title">Dashboard</h2>
                <p class="panel-subtitle">Database overview and statistics</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Databases</div>
                    <div class="stat-value" id="stat-databases">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Collections</div>
                    <div class="stat-value" id="stat-collections">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Documents</div>
                    <div class="stat-value" id="stat-documents">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Storage Used</div>
                    <div class="stat-value" id="stat-storage">0 KB</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Quick Actions</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="createNewDatabase()">Create Database</button>
                    <button class="btn btn-secondary" onclick="openCreateCollectionModal()">Create Collection</button>
                    <button class="btn btn-success" onclick="createBackup()">Backup All</button>
                </div>
            </div>
        </div>

        <!-- Documents Panel -->
        <div class="panel" id="documents">
            <div class="panel-header">
                <h2 class="panel-title">Documents</h2>
                <p class="panel-subtitle">Manage your database documents</p>
            </div>

            <div class="card">
                <h3 class="card-title" id="doc-form-title">Add New Document</h3>
                <input type="hidden" id="doc-edit-id">
                <div class="form-group">
                    <label>Database</label>
                    <select id="doc-database">
                        <option>Select Database</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Collection</label>
                    <select id="doc-collection">
                        <option>Select Collection</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Document ID (optional for new docs)</label>
                    <input type="text" id="doc-id" placeholder="Auto-generated if empty">
                </div>
                <div class="form-group">
                    <label>Document Data (JSON)</label>
                    <textarea id="doc-data" class="code-editor">{
  "name": "Example Document",
  "type": "test",
  "value": 42
}</textarea>
                </div>
                <div class="form-group">
                    <label>Attachments</label>
                    <input type="file" id="doc-attachments" multiple>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="doc-encrypted"> Encrypt Document
                    </label>
                    <input type="password" id="doc-password" placeholder="Encryption password" style="margin-top: 10px; display: none;">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="doc-compressed" checked> Compress Document
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="doc-permanent"> Permanent Document
                    </label>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="doc-submit-btn" onclick="addOrUpdateDocument()">Add Document</button>
                    <button class="btn btn-secondary" id="doc-cancel-btn" style="display: none;" onclick="cancelEditDocument()">Cancel Edit</button>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Document List</h3>
                <div class="table-container">
                    <table id="documents-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Created</th>
                            <th>Modified</th>
                            <th>Permanent</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="documents-table-body">
                        <tr><td colspan="5" style="text-align: center;">Select a database and collection to view documents.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Query Builder Panel -->
        <div class="panel" id="query">
            <div class="panel-header">
                <h2 class="panel-title">Query Builder</h2>
                <p class="panel-subtitle">Build and execute complex queries</p>
            </div>

            <div class="card">
                <div class="query-builder">
                    <div class="query-section">
                        <h3 class="card-title">Query</h3>
                        <div class="form-group">
                            <label>Database</label>
                            <select id="query-database">
                                <option>Select Database</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Collection</label>
                            <select id="query-collection">
                                <option>Select Collection</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filter (MongoDB-style JSON)</label>
                            <textarea id="query-filter" class="code-editor">{
  "type": "test"
}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Projection (optional)</label>
                            <textarea id="query-projection" class="code-editor">{}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Sort (optional)</label>
                            <textarea id="query-sort" class="code-editor">{}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Limit</label>
                            <input type="number" id="query-limit" value="100">
                        </div>
                        <button class="btn btn-primary" onclick="executeQuery()">Execute Query</button>
                    </div>

                    <div class="query-section">
                        <h3 class="card-title">Aggregation Pipeline</h3>
                        <div class="form-group">
                            <label>Pipeline Stages (JSON Array)</label>
                            <textarea id="agg-pipeline" class="code-editor" style="height: 300px;">[
  {
    "$match": {
      "type": "test"
    }
  },
  {
    "$group": {
      "_id": "$category",
      "count": { "$count": {} }
    }
  }
]</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="executeAggregation()">Execute Pipeline</button>
                    </div>
                </div>

                <div class="query-results">
                    <h3 class="card-title">Results</h3>
                    <div id="query-results-content" class="json-viewer"></div>
                </div>
            </div>
        </div>

        <!-- Collections Panel -->
        <div class="panel" id="collections">
            <div class="panel-header">
                <h2 class="panel-title">Collections</h2>
                <p class="panel-subtitle">Manage database collections</p>
            </div>

            <div class="card">
                <h3 class="card-title">Create Collection</h3>
                <div class="form-group">
                    <label>Database</label>
                    <select id="coll-database">
                        <option>Select Database</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Collection Name</label>
                    <input type="text" id="coll-name" placeholder="my-collection">
                </div>
                <button class="btn btn-primary" onclick="createCollection()">Create Collection</button>
            </div>

            <div class="card">
                <h3 class="card-title">Collections List</h3>
                <div id="collections-list" class="table-container"></div>
            </div>
        </div>

        <!-- Sync & Backup Panel -->
        <div class="panel" id="sync">
            <div class="panel-header">
                <h2 class="panel-title">Sync & Backup</h2>
                <p class="panel-subtitle">Backup and restore your databases</p>
            </div>

            <div class="card">
                <h3 class="card-title">Create Backup</h3>
                <div class="form-group">
                    <label>Backup Type</label>
                    <select id="backup-type">
                        <option value="all">All Databases</option>
                        <option value="single">Single Database</option>
                    </select>
                </div>
                <div class="form-group" id="backup-db-select" style="display: none;">
                    <label>Database</label>
                    <select id="backup-database">
                        <option>Select Database</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="backup-encrypted"> Encrypt Backup
                    </label>
                    <input type="password" id="backup-password" placeholder="Encryption password" style="margin-top: 10px; display: none;">
                </div>
                <button class="btn btn-success" onclick="createBackup()">Create Backup</button>
            </div>

            <div class="card">
                <h3 class="card-title">Restore Backup</h3>
                <div class="file-upload" id="restore-upload">
                    <p>Drop backup file here or click to browse</p>
                    <input type="file" id="restore-file" style="display: none;" accept=".json,.backup,.txt">
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>
                        <input type="checkbox" id="restore-encrypted"> Backup is Encrypted
                    </label>
                    <input type="password" id="restore-password" placeholder="Decryption password" style="margin-top: 10px; display: none;">
                </div>
                <button class="btn btn-warning" onclick="restoreBackup()">Restore Backup</button>
            </div>
        </div>

        <!-- Performance Panel -->
        <div class="panel" id="performance">
            <div class="panel-header">
                <h2 class="panel-title">Performance</h2>
                <p class="panel-subtitle">Monitor database performance</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Operations/Sec</div>
                    <div class="stat-value" id="perf-ops">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Latency</div>
                    <div class="stat-value" id="perf-latency">0ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Cache Hit Rate</div>
                    <div class="stat-value" id="perf-cache">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Memory Usage</div>
                    <div class="stat-value" id="perf-memory">0MB</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Performance Monitoring</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" id="start-monitoring-btn" onclick="startMonitoring()">Start Monitoring</button>
                    <button class="btn btn-secondary" id="stop-monitoring-btn" onclick="stopMonitoring()">Stop Monitoring</button>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Optimization Tips</h3>
                <div id="optimization-tips"></div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="panel" id="settings">
            <div class="panel-header">
                <h2 class="panel-title">Settings</h2>
                <p class="panel-subtitle">Configure database settings</p>
            </div>

            <div class="form-group">
                <label>Select Database to Configure</label>
                <select id="settings-database">
                    <option>Select Database</option>
                </select>
            </div>

            <div class="card">
                <h3 class="card-title">Storage Settings</h3>
                <div class="form-group">
                    <label>Size Limit (KB)</label>
                    <input type="number" id="size-limit" placeholder="Infinity">
                </div>
                <div class="form-group">
                    <label>Buffer Limit (KB)</label>
                    <input type="number" id="buffer-limit" placeholder="80% of size limit">
                </div>
                <div class="form-group">
                    <label>Cleanup Interval (ms)</label>
                    <input type="number" id="cleanup-interval" value="10000">
                </div>
                <button class="btn btn-primary" onclick="updateDbSettings()">Update Settings</button>
            </div>

            <div class="card">
                <h3 class="card-title">Danger Zone</h3>
                <button class="btn btn-danger" onclick="dropDatabase()">Drop Selected Database</button>
                <button class="btn btn-danger" onclick="clearAllData()">Clear All Data From All Databases</button>
            </div>
        </div>

        <!-- Developer Panel -->
        <div class="panel" id="developer">
            <div class="panel-header">
                <h2 class="panel-title">Developer Console</h2>
                <p class="panel-subtitle">Direct database interaction</p>
            </div>

            <div class="card">
                <h3 class="card-title">JavaScript Console</h3>
                <div class="form-group">
                    <label>Execute JavaScript Code</label>
                    <textarea id="dev-code" class="code-editor" style="height: 200px;">// Access the database instance via the `db` variable
// Example: await db.getDatabase('my-db-name');
const myDb = await db.getDatabase('test');
const coll = await myDb.getCollection('users').catch(() => myDb.createCollection('users'));
await coll.add({ name: 'John Doe', age: 30, timestamp: new Date() });
const docs = await coll.getAll();
console.log('Documents in "users":', docs);</textarea>
                </div>
                <button class="btn btn-primary" onclick="executeCode()">Execute</button>
            </div>

            <div class="console" id="dev-console">
                <div class="console-line">
                    <span class="console-prompt">></span> Ready for commands...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Modal Title</h3>
        </div>
        <div id="modal-body"></div>
        <div class="btn-group" id="modal-buttons">
            <button class="btn btn-primary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script src="browser.min.js"></script>
<script>
    // --- Globals ---
    let db = null;
    let perfInterval = null;

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            let LDB;
            if (window.LacertaDB) {
                LDB = window.LacertaDB;
            } else if (window.lacerta && window.lacerta.LacertaDB) {
                // Fallback for older bundle structure
                LDB = window.lacerta.LacertaDB;
            }

            if (LDB) {
                db = new LDB();
                console.log('LacertaDB v4 Initialized Successfully');
                await updateDashboard();
            } else {
                showNotification('Failed to load LacertaDB module. Make sure browser.min.js is loaded.', 'error');
            }
        } catch (error) {
            console.error('Failed to initialize LacertaDB:', error);
            showNotification(`Initialization failed: ${error.message}`, 'error');
        }
    });

    // --- Navigation & UI Updates ---
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            item.classList.add('active');
            const panelId = item.dataset.panel;
            document.getElementById(panelId).classList.add('active');

            // Update panel-specific data on view
            switch (panelId) {
                case 'dashboard': updateDashboard(); break;
                case 'collections': updateCollectionsList(); break;
                case 'documents': updateDatabaseSelects(); break;
                case 'query': updateDatabaseSelects(); break;
                case 'sync': updateDatabaseSelects(); break;
                case 'settings': updateDatabaseSelects(); break;
            }
        });
    });

    async function updateDashboard() {
        if (!db) return;
        try {
            const databases = db.listDatabases();
            document.getElementById('stat-databases').textContent = databases.length;

            let totalCollections = 0, totalDocuments = 0, totalSize = 0;

            for (const dbName of databases) {
                const database = await db.getDatabase(dbName);
                const stats = database.getStats();
                totalCollections += stats.collections.length;
                totalDocuments += stats.totalDocuments;
                totalSize += stats.totalSizeKB;
            }

            document.getElementById('stat-collections').textContent = totalCollections;
            document.getElementById('stat-documents').textContent = totalDocuments;
            document.getElementById('stat-storage').textContent = formatSize(totalSize * 1024);

            await updateDatabaseSelects();
        } catch (error) {
            console.error('Dashboard update error:', error);
            showNotification('Could not update dashboard stats.', 'error');
        }
    }

    async function updateDatabaseSelects() {
        if (!db) return;
        const databases = db.listDatabases();
        const selects = [
            'doc-database', 'query-database', 'coll-database',
            'backup-database', 'settings-database'
        ];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                const currentVal = select.value;
                select.innerHTML = '<option value="">Select Database</option>';
                databases.forEach(dbName => {
                    const option = new Option(dbName, dbName);
                    select.appendChild(option);
                });
                if (databases.includes(currentVal)) {
                    select.value = currentVal;
                }
            }
        });
    }

    async function updateCollectionSelect(dbName, selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select Collection</option>';
        if (dbName) {
            const database = await db.getDatabase(dbName);
            const collections = database.listCollections();
            collections.forEach(collName => {
                select.add(new Option(collName, collName));
            });
        }
    }

    // --- Database & Collection Management ---
    async function createNewDatabase() {
        const name = prompt('Enter new database name:');
        if (name && name.trim()) {
            try {
                await db.getDatabase(name.trim());
                showNotification(`Database "${name}" created`, 'success');
                await updateDashboard();
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
    }

    async function createCollection() {
        try {
            const dbName = document.getElementById('coll-database').value;
            const collName = document.getElementById('coll-name').value;
            if (!dbName || !collName) {
                showNotification('Database and collection name are required.', 'warning');
                return;
            }
            const database = await db.getDatabase(dbName);
            await database.createCollection(collName);
            showNotification(`Collection "${collName}" created`, 'success');
            await updateCollectionsList();
            await updateDashboard();
            document.getElementById('coll-name').value = '';
        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
        }
    }

    async function updateCollectionsList() {
        if (!db) return;
        const container = document.getElementById('collections-list');
        container.innerHTML = '<table><thead><tr><th>Database</th><th>Collection</th><th>Documents</th><th>Size</th><th>Actions</th></tr></thead><tbody id="collections-table-body"></tbody></table>';
        const tableBody = document.getElementById('collections-table-body');
        tableBody.innerHTML = '';

        const databases = db.listDatabases();
        if (databases.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No databases found.</td></tr>';
            return;
        }

        for (const dbName of databases) {
            const database = await db.getDatabase(dbName);
            const stats = database.getStats();
            if (stats.collections.length === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `<td>${dbName}</td><td colspan="4" style="text-align: center;">No collections in this database.</td>`;
            } else {
                stats.collections.forEach(coll => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                            <td>${dbName}</td>
                            <td>${coll.name}</td>
                            <td>${coll.documents}</td>
                            <td>${formatSize(coll.sizeKB * 1024)}</td>
                            <td class="actions">
                                <button class="btn btn-danger btn-sm" onclick="dropCollection('${dbName}', '${coll.name}')">Drop</button>
                            </td>
                        `;
                });
            }
        }
    }

    async function dropCollection(dbName, collName) {
        showModal(
            'Confirm Deletion',
            `<p>Are you sure you want to drop collection "<strong>${collName}</strong>" from "<strong>${dbName}</strong>"? This action is irreversible.</p>`,
            [
                { text: 'Cancel', class: 'btn-secondary' },
                { text: 'Drop Collection', class: 'btn-danger', onClick: async () => {
                        try {
                            const database = await db.getDatabase(dbName);
                            await database.dropCollection(collName);
                            showNotification(`Collection "${collName}" dropped`, 'success');
                            await updateCollectionsList();
                            await updateDashboard();
                        } catch (error) { showNotification(`Error: ${error.message}`, 'error'); }
                    }}
            ]
        );
    }

    // --- Document Management ---
    async function addOrUpdateDocument() {
        try {
            const dbName = document.getElementById('doc-database').value;
            const collName = document.getElementById('doc-collection').value;
            const editId = document.getElementById('doc-edit-id').value;
            const docId = document.getElementById('doc-id').value || undefined;
            let docData;
            try {
                docData = JSON.parse(document.getElementById('doc-data').value);
            } catch(e) {
                showNotification('Invalid JSON in document data.', 'error');
                return;
            }

            const files = document.getElementById('doc-attachments').files;
            const options = {
                id: docId,
                encrypted: document.getElementById('doc-encrypted').checked,
                password: document.getElementById('doc-password').value || undefined,
                compressed: document.getElementById('doc-compressed').checked,
                permanent: document.getElementById('doc-permanent').checked,
                attachments: files.length > 0 ? Array.from(files) : undefined
            };

            const database = await db.getDatabase(dbName);
            const collection = await database.getCollection(collName);

            if (editId) {
                await collection.update(editId, docData, options);
                showNotification(`Document ${editId} updated successfully.`, 'success');
            } else {
                const newId = await collection.add(docData, options);
                showNotification(`Document added with ID: ${newId}`, 'success');
            }

            cancelEditDocument(); // Reset form
            await listDocuments(dbName, collName);
            await updateDashboard();

        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
        }
    }

    async function listDocuments(dbName, collName) {
        const tableBody = document.getElementById('documents-table-body');
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>';
        if (!dbName || !collName) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Select a database and collection.</td></tr>';
            return;
        }
        try {
            const database = await db.getDatabase(dbName);
            const collection = await database.getCollection(collName);
            // We'll get just the metadata to list, not the full data for performance.
            const docs = await collection.query({}, { projection: { _id: 1, _created: 1, _modified: 1, _permanent: 1 } });

            if (docs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No documents in this collection.</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            docs.forEach(doc => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                        <td class="document-id" title="${doc._id}">${doc._id}</td>
                        <td>${new Date(doc._created).toLocaleString()}</td>
                        <td>${new Date(doc._modified).toLocaleString()}</td>
                        <td>${doc._permanent ? 'Yes' : 'No'}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="viewDocument('${dbName}', '${collName}', '${doc._id}')">View</button>
                            <button class="btn btn-warning btn-sm" onclick="editDocument('${dbName}', '${collName}', '${doc._id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDocument('${dbName}', '${collName}', '${doc._id}')">Delete</button>
                        </td>
                    `;
            });
        } catch(error) {
            showNotification(`Error listing documents: ${error.message}`, 'error');
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--danger);">Error loading documents.</td></tr>`;
        }
    }

    async function viewDocument(dbName, collName, docId) {
        try {
            const database = await db.getDatabase(dbName);
            const collection = await database.getCollection(collName);
            const doc = await collection.get(docId, { includeAttachments: true });

            const content = document.createElement('div');
            content.innerHTML = `<div class="json-viewer">${syntaxHighlight(JSON.stringify(doc, null, 2))}</div>`;
            showModal(`Document: ${docId}`, content);
        } catch (error) {
            showNotification(`Error getting document: ${error.message}`, 'error');
        }
    }

    async function editDocument(dbName, collName, docId) {
        try {
            const database = await db.getDatabase(dbName);
            const collection = await database.getCollection(collName);
            const doc = await collection.get(docId); // get raw data without metadata

            document.getElementById('doc-form-title').textContent = `Editing Document: ${docId}`;
            document.getElementById('doc-submit-btn').textContent = 'Update Document';
            document.getElementById('doc-cancel-btn').style.display = 'inline-flex';

            document.getElementById('doc-edit-id').value = doc._id;
            document.getElementById('doc-id').value = doc._id;
            document.getElementById('doc-id').readOnly = true;

            // Separate metadata from user data for editing
            const { _id, _created, _modified, _permanent, _attachments, ...dataToEdit } = doc;
            document.getElementById('doc-data').value = JSON.stringify(dataToEdit, null, 2);
            document.getElementById('doc-permanent').checked = _permanent;
            // Note: cannot edit encryption/compression on existing docs this way yet. This is a simplification.

            window.scrollTo({ top: 0, behavior: 'smooth' });

        } catch (error) {
            showNotification(`Error loading document for editing: ${error.message}`, 'error');
        }
    }

    function cancelEditDocument() {
        document.getElementById('doc-form-title').textContent = 'Add New Document';
        document.getElementById('doc-submit-btn').textContent = 'Add Document';
        document.getElementById('doc-cancel-btn').style.display = 'none';
        document.getElementById('doc-edit-id').value = '';
        document.getElementById('doc-id').value = '';
        document.getElementById('doc-id').readOnly = false;
        document.getElementById('doc-data').value = '{\n  "key": "value"\n}';
        document.getElementById('doc-attachments').value = '';
        document.getElementById('doc-encrypted').checked = false;
        document.getElementById('doc-permanent').checked = false;
    }

    async function deleteDocument(dbName, collName, docId) {
        showModal(
            'Confirm Deletion',
            `<p>Are you sure you want to delete document "<strong>${docId}</strong>"? This action is irreversible.</p>`,
            [
                { text: 'Cancel', class: 'btn-secondary' },
                { text: 'Delete Document', class: 'btn-danger', onClick: async () => {
                        try {
                            const database = await db.getDatabase(dbName);
                            const collection = await database.getCollection(collName);
                            await collection.delete(docId);
                            showNotification(`Document "${docId}" deleted`, 'success');
                            await listDocuments(dbName, collName);
                            await updateDashboard();
                        } catch (error) { showNotification(`Error: ${error.message}`, 'error'); }
                    }}
            ]
        );
    }

    // --- Query & Aggregation ---
    async function executeQuery() {
        try {
            const dbName = document.getElementById('query-database').value;
            const collName = document.getElementById('query-collection').value;
            const filter = JSON.parse(document.getElementById('query-filter').value);
            const projection = JSON.parse(document.getElementById('query-projection').value);
            const sort = JSON.parse(document.getElementById('query-sort').value);
            const limit = parseInt(document.getElementById('query-limit').value);

            const database = await db.getDatabase(dbName);
            const collection = await database.getCollection(collName);

            const results = await collection.query(filter, {
                projection: Object.keys(projection).length > 0 ? projection : undefined,
                sort: Object.keys(sort).length > 0 ? sort : undefined,
                limit
            });
            displayQueryResults(results);
        } catch (error) {
            showNotification(`Query error: ${error.message}`, 'error');
            displayQueryResults({ error: error.message });
        }
    }

    async function executeAggregation() {
        try {
            const dbName = document.getElementById('query-database').value;
            const collName = document.getElementById('query-collection').value;
            const pipeline = JSON.parse(document.getElementById('agg-pipeline').value);

            const database = await db.getDatabase(dbName);
            const collection = await database.getCollection(collName);

            const results = await collection.aggregate(pipeline);
            displayQueryResults(results);
        } catch (error) {
            showNotification(`Aggregation error: ${error.message}`, 'error');
            displayQueryResults({ error: error.message });
        }
    }

    function displayQueryResults(results) {
        const container = document.getElementById('query-results-content');
        container.innerHTML = syntaxHighlight(JSON.stringify(results, null, 2));
    }

    // --- Backup & Restore ---
    async function createBackup() {
        try {
            const type = document.getElementById('backup-type').value;
            const encrypted = document.getElementById('backup-encrypted').checked;
            const password = document.getElementById('backup-password').value;

            let backupData;
            let fileName = `lacerta-backup-${Date.now()}`;
            if (type === 'all') {
                backupData = await db.createBackup(encrypted ? password : null);
            } else {
                const dbName = document.getElementById('backup-database').value;
                if (!dbName) {
                    showNotification('Please select a database to back up.', 'warning');
                    return;
                }
                fileName += `-${dbName}`;
                const database = await db.getDatabase(dbName);
                backupData = await database.export(encrypted ? 'encrypted' : 'json', password);
            }

            const blob = new Blob([backupData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.txt`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            showNotification('Backup created successfully', 'success');
        } catch (error) {
            showNotification(`Backup error: ${error.message}`, 'error');
        }
    }

    async function restoreBackup() {
        const fileInput = document.getElementById('restore-file');
        if (fileInput.files.length === 0) {
            return showNotification('Please select a backup file.', 'warning');
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            const backupData = e.target.result;
            const encrypted = document.getElementById('restore-encrypted').checked;
            const password = document.getElementById('restore-password').value;
            try {
                const result = await db.restoreBackup(backupData, encrypted ? password : null);
                showNotification(`Restored: ${result.databases} DBs, ${result.collections} collections, ${result.documents} docs.`, 'success');
                await updateDashboard();
            } catch (error) {
                showNotification(`Restore failed: ${error.message}`, 'error');
            }
        };
        reader.readAsText(file);
    }

    // --- Performance ---
    function startMonitoring() {
        if (db && db.performanceMonitor && !perfInterval) {
            db.performanceMonitor.startMonitoring();
            perfInterval = setInterval(updatePerformance, 1000);
            showNotification('Performance monitoring started', 'success');
        }
    }
    function stopMonitoring() {
        if (db && db.performanceMonitor && perfInterval) {
            db.performanceMonitor.stopMonitoring();
            clearInterval(perfInterval);
            perfInterval = null;
            showNotification('Performance monitoring stopped', 'success');
        }
    }
    function updatePerformance() {
        if (db && db.performanceMonitor) {
            const stats = db.performanceMonitor.getStats();
            document.getElementById('perf-ops').textContent = stats.opsPerSec;
            document.getElementById('perf-latency').textContent = `${stats.avgLatency}ms`;
            document.getElementById('perf-cache').textContent = `${stats.cacheHitRate}%`;
            document.getElementById('perf-memory').textContent = `${stats.memoryUsageMB}MB`;

            const tips = db.performanceMonitor.getOptimizationTips();
            document.getElementById('optimization-tips').innerHTML = tips.map(tip => `<p>‚Ä¢ ${tip}</p>`).join('');
        }
    }

    // --- Settings ---
    async function updateDbSettings() {
        const dbName = document.getElementById('settings-database').value;
        if (!dbName) return showNotification('Select a database to configure.', 'warning');
        try {
            const database = await db.getDatabase(dbName);
            const settings = {
                sizeLimitKB: parseFloat(document.getElementById('size-limit').value) || Infinity,
                bufferLimitKB: parseFloat(document.getElementById('buffer-limit').value) || undefined,
                freeSpaceEvery: parseInt(document.getElementById('cleanup-interval').value) || 10000,
            };
            database.updateSettings(settings);
            showNotification(`Settings for "${dbName}" updated.`, 'success');
        } catch(error) {
            showNotification(`Error updating settings: ${error.message}`, 'error');
        }
    }

    async function dropDatabase() {
        const dbName = document.getElementById('settings-database').value;
        if (!dbName) return showNotification('Select a database to drop.', 'warning');
        showModal('Confirm Drop Database', `<p>Really drop database "<strong>${dbName}</strong>"? All collections and documents will be lost.</p>`, [
            { text: 'Cancel', class: 'btn-secondary' },
            { text: 'Drop Database', class: 'btn-danger', onClick: async () => {
                    try {
                        await db.dropDatabase(dbName);
                        showNotification(`Database "${dbName}" dropped.`, 'success');
                        await updateDashboard();
                    } catch (error) { showNotification(`Error: ${error.message}`, 'error'); }
                }}
        ]);
    }

    async function clearAllData() {
        showModal('Confirm Clear All Data', `<p>This will permanently delete ALL data from EVERY database. Are you absolutely sure?</p>`, [
            { text: 'Cancel', class: 'btn-secondary' },
            { text: 'DELETE EVERYTHING', class: 'btn-danger', onClick: async () => {
                    try {
                        const databases = db.listDatabases();
                        for (const dbName of databases) {
                            await db.dropDatabase(dbName);
                        }
                        showNotification('All data cleared.', 'success');
                        await updateDashboard();
                    } catch (error) { showNotification(`Error: ${error.message}`, 'error'); }
                }}
        ]);
    }

    // --- Developer Console ---
    async function executeCode() {
        const code = document.getElementById('dev-code').value;
        const consoleDiv = document.getElementById('dev-console');

        const customConsole = {
            log: (...args) => {
                const output = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' ');
                const line = document.createElement('div');
                line.className = 'console-line console-success';
                line.innerHTML = `<span class="console-prompt">></span> ${output}`;
                consoleDiv.appendChild(line);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            },
            error: (...args) => {
                const output = args.map(arg => arg instanceof Error ? arg.message : arg).join(' ');
                const line = document.createElement('div');
                line.className = 'console-line console-error';
                line.innerHTML = `<span class="console-prompt">!</span> ${output}`;
                consoleDiv.appendChild(line);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
        };

        try {
            const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
            const fn = new AsyncFunction('db', 'console', code);
            await fn(db, customConsole);
        } catch (error) {
            customConsole.error(error);
        }
    }

    // --- Event Listeners ---
    document.getElementById('doc-encrypted').addEventListener('change', (e) => {
        document.getElementById('doc-password').style.display = e.target.checked ? 'block' : 'none';
    });
    document.getElementById('backup-encrypted').addEventListener('change', (e) => {
        document.getElementById('backup-password').style.display = e.target.checked ? 'block' : 'none';
    });
    document.getElementById('restore-encrypted').addEventListener('change', (e) => {
        document.getElementById('restore-password').style.display = e.target.checked ? 'block' : 'none';
    });
    document.getElementById('backup-type').addEventListener('change', (e) => {
        document.getElementById('backup-db-select').style.display = e.target.value === 'single' ? 'block' : 'none';
    });
    document.getElementById('doc-database').addEventListener('change', (e) => updateCollectionSelect(e.target.value, 'doc-collection'));
    document.getElementById('query-database').addEventListener('change', (e) => updateCollectionSelect(e.target.value, 'query-collection'));
    document.getElementById('doc-collection').addEventListener('change', (e) => listDocuments(document.getElementById('doc-database').value, e.target.value));

    // --- Helpers ---
    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s forwards';
            notification.addEventListener('animationend', () => notification.remove());
        }, 3000);
    }

    function showModal(title, body, buttons = []) {
        document.getElementById('modal-title').textContent = title;
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = '';
        if (typeof body === 'string') {
            modalBody.innerHTML = body;
        } else {
            modalBody.appendChild(body);
        }
        const btnGroup = document.getElementById('modal-buttons');
        btnGroup.innerHTML = '';

        if (buttons.length > 0) {
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.className = `btn ${btnInfo.class || 'btn-secondary'}`;
                button.textContent = btnInfo.text;
                button.onclick = () => { if (btnInfo.onClick) btnInfo.onClick(); closeModal(); };
                btnGroup.appendChild(button);
            });
        }
        const closeButton = document.createElement('button');
        closeButton.className = 'btn btn-primary';
        closeButton.textContent = buttons.length > 0 ? 'Close' : 'OK';
        closeButton.onclick = closeModal;
        btnGroup.appendChild(closeButton);

        document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('show');
    }

    function syntaxHighlight(json) {
        if (!json) return '';
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            let cls = 'json-number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'json-key';
                } else {
                    cls = 'json-string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'json-boolean';
            } else if (/null/.test(match)) {
                cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

</script>
</body>
</html>
